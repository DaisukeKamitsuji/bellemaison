/*!
 * Zoom'n Galleria v1.1.14
 * http://www.ibro.co.jp/product/snaprec/galleria/
 *
 * Copyright 2011, i-Broadcast inc.
 */
(function($){var Class={instance:function(){var a=$.makeArray(arguments);var c=a.shift();var o={};o.__proto__=(c instanceof Object)?c.prototype:Object.prototype;if($.isFunction(c)){var r=c.apply(o,a);return(r instanceof Object)?r:o}else{return o}},create:function(su,def){su=su?su:Object;var c=function(){var self=this;this.parent=function(){var a=$.makeArray(arguments);a.unshift(su);self.parent=Class.instance.apply(Class,a)};this.init.apply(this,arguments)};for(var p in su.prototype){c.prototype[p]=su.prototype[p]}for(var p in def){c.prototype[p]=def[p]}c.prototype.constructor=c;return c}};var Log={_flag:false,_m:null,_cnt:0,init:function(m){this._flag=true;this._m=m[0];this.output("initialize")},output:function(msg){for(var p=1;p<arguments.length;p++){msg+=","+arguments[p]}this._cnt++;if(this._cnt>1000){this._cnt=0;if(this._m){this._m.innerHTML=""}}if(this._flag&&console){console.log(msg)}},scan:function(obj){for(var p in obj){this.output(p+":"+obj[p])}}};var Config=Class.create(null,{id:null,log:null,mode:null,viewer:null,param:null,length:null,images:null,images_loop:null,text:null,page:null,init_index:null,open:null,show:null,close:null,zoom:null,restore:null,click:null,enable_filepath:null,disable_filepath:null,enable_filename:null,disable_filename:null,close_button_image:null,prev_button_image:null,next_button_image:null,zoom_cursor:null,zoom_cursor_image:null,move_cursor:null,move_cursor_image:null,restore_cursor:null,restore_cursor_image:null,text_as_html:true,init:function(id,opts,params){if(!id){return}var _opts={};var _images=[];if(!opts){var opts={}}if(!opts.zoom_cursor_image){opts.zoom_cursor_image={}}if(!opts.move_cursor_image){opts.move_cursor_image={}}if(!opts.restore_cursor_image){opts.restore_cursor_image={}}if(!opts.close_button_image){opts.close_button_image={}}if(!opts.prev_button_image){opts.prev_button_image={}}if(!opts.next_button_image){opts.next_button_image={}}if(!Config.zoom_cursor_image){Config.zoom_cursor_image={}}if(!Config.move_cursor_image){Config.move_cursor_image={}}if(!Config.restore_cursor_image){Config.restore_cursor_image={}}if(!Config.close_button_image){Config.close_button_image={}}if(!Config.prev_button_image){Config.prev_button_image={}}if(!Config.next_button_image){Config.next_button_image={}}if(!Config.images){Config.images=[]}if(params){for(var p=0;p<params.length;p++){var param=params[p];_opts[param.name]=param.value}}this.set_id(id);this.set_mode(opts,_opts);this.set_log(opts,_opts);this.set_viewer(opts,_opts);this.set_curs(opts,_opts);this.set_regexp(opts,_opts);this.set_btns(opts,_opts);this.set_handles(opts,_opts);this.set_valids(opts,_opts);this.set_images(opts,_opts);this.set_init_index(opts,_opts);this.set_text_as_html(opts,_opts)},set_id:function(id){this.id=(id)?id:Config.id},set_mode:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}this.mode=this.strval(_opts.mode,opts.mode,Config.mode)},set_log:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}this.log=this.strval(_opts.log,opts.log,Config.log);if(this.log){this.log=$("#"+this.log)}},set_viewer:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}this.viewer=this.strval(_opts.viewer,opts.viewer,Config.viewer);if(this.viewer){this.viewer=$("#"+this.viewer)}},set_curs:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}this.zoom_cursor=this.strval(_opts.zoom_cursor,opts.zoom_cursor,Config.zoom_cursor);this.zoom_cursor_image={src:this.strval(_opts.zoom_cursor_image_src,opts.zoom_cursor_image.src,Config.zoom_cursor_image.src),cur:this.strval(_opts.zoom_cursor_image_cur,opts.zoom_cursor_image.cur,Config.zoom_cursor_image.cur),width:Number(this.strval(_opts.zoom_cursor_image_width,opts.zoom_cursor_image.width,Config.zoom_cursor_image.width)),height:Number(this.strval(_opts.zoom_cursor_image_height,opts.zoom_cursor_image.height,Config.zoom_cursor_image.height))};this.move_cursor=this.strval(_opts.move_cursor,opts.move_cursor,Config.move_cursor);this.move_cursor_image={src:this.strval(_opts.move_cursor_image_src,opts.move_cursor_image.src,Config.move_cursor_image.src),cur:this.strval(_opts.move_cursor_image_cur,opts.move_cursor_image.cur,Config.move_cursor_image.cur),width:Number(this.strval(_opts.move_cursor_image_width,opts.move_cursor_image.width,Config.move_cursor_image.width)),height:Number(this.strval(_opts.move_cursor_image_height,opts.move_cursor_image.height,Config.move_cursor_image.height))};this.restore_cursor=this.strval(_opts.restore_cursor,opts.restore_cursor,Config.restore_cursor);this.restore_cursor_image={src:this.strval(_opts.restore_cursor_image_src,opts.restore_cursor_image.src,Config.restore_cursor_image.src),cur:this.strval(_opts.restore_cursor_image_cur,opts.restore_cursor_image.cur,Config.restore_cursor_image.cur),width:Number(this.strval(_opts.restore_cursor_image_width,opts.restore_cursor_image.width,Config.restore_cursor_image.width)),height:Number(this.strval(_opts.restore_cursor_image_height,opts.restore_cursor_image.height,Config.restore_cursor_image.height))}},set_regexp:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}if(_opts.enable_filepath){this.enable_filepath=this.strreg(_opts.enable_filepath)}else{if(opts.enable_filepath){this.enable_filepath=opts.enable_filepath}else{this.enable_filepath=Config.enable_filepath}}if(_opts.disable_filepath){this.disable_filepath=this.strreg(_opts.disable_filepath)}else{if(opts.disable_filepath){this.disable_filepath=opts.disable_filepath}else{this.disable_filepath=Config.disable_filepath}}if(_opts.enable_filename){this.enable_filename=this.strreg(_opts.enable_filename)}else{if(opts.enable_filename){this.enable_filename=opts.enable_filename}else{this.enable_filename=Config.enable_filename}}if(_opts.disable_filename){this.disable_filename=this.strreg(_opts.disable_filename)}else{if(opts.disable_filename){this.disable_filename=opts.disable_filename}else{this.disable_filename=Config.disable_filename}}},set_btns:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}this.close_button_image={src:this.strval(_opts.close_button_image_src,opts.close_button_image.src,Config.close_button_image.src),hover:this.strval(_opts.close_button_image_hover,opts.close_button_image.hover,Config.close_button_image.hover),width:Number(this.strval(_opts.close_button_image_width,opts.close_button_image.width,Config.close_button_image.width)),height:Number(this.strval(_opts.close_button_image_height,opts.close_button_image.height,Config.close_button_image.height))};this.prev_button_image={src:this.strval(_opts.prev_button_image_src,opts.prev_button_image.src,Config.prev_button_image.src),hover:this.strval(_opts.prev_button_image_hover,opts.prev_button_image.hover,Config.prev_button_image.hover),width:Number(this.strval(_opts.prev_button_image_width,opts.prev_button_image.width,Config.prev_button_image.width)),height:Number(this.strval(_opts.prev_button_image_height,opts.prev_button_image.height,Config.prev_button_image.height))};this.next_button_image={src:this.strval(_opts.next_button_image_src,opts.next_button_image.src,Config.next_button_image.src),hover:this.strval(_opts.next_button_image_hover,opts.next_button_image.hover,Config.next_button_image.hover),width:Number(this.strval(_opts.next_button_image_width,opts.next_button_image.width,Config.next_button_image.width)),height:Number(this.strval(_opts.next_button_image_height,opts.next_button_image.height,Config.next_button_image.height))}},set_handles:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}if(_opts.open){this.open=this.strhnd(_opts.open)}else{if(opts.open){this.open=opts.open}else{this.open=Config.open}}if(_opts.show){this.show=this.strhnd(_opts.show)}else{if(opts.show){this.show=opts.show}else{this.show=Config.show}}if(_opts.close){this.close=this.strhnd(_opts.close)}else{if(opts.close){this.close=opts.close}else{this.close=Config.close}}if(_opts.zoom){this.zoom=this.strhnd(_opts.zoom)}else{if(opts.zoom){this.zoom=opts.zoom}else{this.zoom=Config.zoom}}if(_opts.restore){this.restore=this.strhnd(_opts.restore)}else{if(opts.restore){this.restore=opts.restore}else{this.restore=Config.restore}}if(_opts.click){this.click=this.strhnd(_opts.click)}else{if(opts.click){this.click=opts.click}else{this.click=Config.click}}},set_valids:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}if(_opts.page=="true"){this.page=true}else{if(_opts.page=="false"){this.page=false}else{if(opts.page==true||opts.page==false){this.page=opts.page}else{if(this.mode=="view"&&(Config.view_page==true||Config.view_page==false)){this.page=Config.view_page}else{if(this.mode=="window"&&(Config.window_page==true||Config.window_page==false)){this.page=Config.window_page}else{this.page=Config.page}}}}}if(_opts.text=="true"){this.text=true}else{if(_opts.text=="false"){this.text=false}else{if(opts.text==true||opts.text==false){this.text=opts.text}else{if(this.mode=="view"&&(Config.view_text==true||Config.view_text==false)){this.text=Config.view_text}else{if(this.mode=="window"&&(Config.window_text==true||Config.window_text==false)){this.text=Config.window_text}else{this.text=Config.text}}}}}if(_opts.images_loop=="true"){this.images_loop=true}else{if(_opts.images_loop=="false"){this.images_loop=false}else{if(opts.images_loop==true||opts.images_loop==false){this.images_loop=opts.images_loop}else{if(this.mode=="view"&&(Config.view_images_loop==true||Config.view_images_loop==false)){this.images_loop=Config.view_images_loop}else{if(this.mode=="window"&&(Config.window_images_loop==true||Config.window_images_loop==false)){this.images_loop=Config.window_images_loop}else{this.images_loop=Config.images_loop}}}}}},set_images:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}var images1=(opts.images)?opts.images:[];var images2=[];if(_opts.length>0){for(var p=0;p<_opts.length;p++){images2[p]={};images2[p].src=_opts["src"+(p+1)];if(_opts["width"+(p+1)]){images2[p].width=eval("["+_opts["width"+(p+1)]+"]")}if(_opts["height"+(p+1)]){images2[p].height=eval("["+_opts["height"+(p+1)]+"]")}images2[p].text=(_opts["text"+(p+1)]!=undefined)?_opts["text"+(p+1)]:"";var len1=0;var len2=0;if(images2[p].width){var len1=images2[p].width.length}else{if(images1[p]&&images1[p].width){var len1=images1[p].width.length}}if(images2[p].height){var len2=images2[p].height.length}else{if(images1[p]&&images1[p].height){var len2=images1[p].height.length}}var len=Math.min(len1,len2);for(var n=0;n<len;n++){images2[p]["image"+(n+1)+"_src"]=_opts["image"+(n+1)+"_src"+(p+1)]?_opts["image"+(n+1)+"_src"+(p+1)]:images2[p].src;images2[p]["image"+(n+1)+"_rec"]=_opts["image"+(n+1)+"_rec"+(p+1)]=="false"?false:true}}}if(!isNaN(opts.length)){var length1=opts.length}else{var length1=images1.length}var length2=images2.length;var length3=(opts.length>0)?opts.length:0;var length4=Config.images.length;var length5=Config.length;this.length=Math.max(Math.max(Math.max(Math.max(length1,length2),length3),length4),length5);if(this.length==0){throw new Error("Initialization Error")}this.images=[];for(var p=0;p<this.length;p++){this.images[p]={};if(images2[p]&&images2[p].src){this.images[p].src=images2[p].src}else{if(images1[p]&&images1[p].src){this.images[p].src=images1[p].src}else{if(Config.images[p]){this.images[p].src=Config.images[p].src}else{throw new Error("Invalid Image Error")}}}if(images2[p]&&images2[p].width&&images2[p].height){var len=Math.min(images2[p].width.length,images2[p].height.length)}else{if(images1[p]&&images1[p].width&&images1[p].height){var len=Math.min(images1[p].width.length,images1[p].height.length)}else{if(Config.images[p]&&Config.images[p].width&&Config.images[p].height){var len=Math.min(Config.images[p].width.length,Config.images[p].height.length)}else{throw new Error("Invalid Image Error")}}}for(var n=0;n<len;n++){if(images2[p]&&images2[p]["image"+(n+1)+"_src"]){this.images[p]["image"+(n+1)+"_src"]=images2[p]["image"+(n+1)+"_src"]}else{if(images1[p]&&images1[p]["image"+(n+1)+"_src"]){this.images[p]["image"+(n+1)+"_src"]=images1[p]["image"+(n+1)+"_src"]}else{if(Config.images[p]){this.images[p]["image"+(n+1)+"_src"]=Config.images[p]["image"+(n+1)+"_src"]}else{this.images[p]["image"+(n+1)+"_src"]=this.images[p].src}}}}for(var n=0;n<len;n++){if(images2[p]&&images2[p]["image"+(n+1)+"_rec"]==false){this.images[p]["image"+(n+1)+"_rec"]=false}else{if(images1[p]&&images1[p]["image"+(n+1)+"_rec"]==false){this.images[p]["image"+(n+1)+"_rec"]=false}else{if(Config.images[p]&&Config.images[p]["image"+(n+1)+"_rec"]==false){this.images[p]["image"+(n+1)+"_rec"]=false}else{this.images[p]["image"+(n+1)+"_rec"]=true}}}}if(images2[p]&&images2[p].width){this.images[p].width=images2[p].width}else{if(images1[p]&&images1[p].width){this.images[p].width=images1[p].width}else{if(Config.images[p]){this.images[p].width=Config.images[p].width}else{throw new Error("Invalid Image Error")}}}if(images2[p]&&images2[p].height){this.images[p].height=images2[p].height}else{if(images1[p]&&images1[p].height){this.images[p].height=images1[p].height}else{if(Config.images[p]){this.images[p].height=Config.images[p].height}else{throw new Error("Invalid Image Error")}}}if(images2[p]&&images2[p].text){this.images[p].text=images2[p].text}else{if(images1[p]&&images1[p].text){this.images[p].text=images1[p].text}else{if(Config.images[p]){this.images[p].text=Config.images[p].text}else{this.images[p].text=""}}}if(!this.images[p].width||!this.images[p].height||this.images[p].width.length==0||this.images[p].height.length==0){throw new Error("Invalid Image Error")}if(this.images[p].width.length!=this.images[p].height.length){throw new Error("Invalid Image Error")}}},set_init_index:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}if(_opts.init_index){this.init_index=Number(_opts.init_index)-1}else{if(opts.init_index){this.init_index=Number(opts.init_index)-1}else{this.init_index=Config.init_index-1}}if(this.init_index<0){this.init_index=0}if(this.init_index>=this.length){throw new Error("Initialization Error")}},set_text_as_html:function(opts,_opts){if(!opts){opts={}}if(!_opts){_opts={}}if(_opts.text_as_html=="true"||_opts.text_as_html=="false"){this.text_as_html=_opts.text_as_html=="true"?true:false}else{if(opts.text_as_html==true||opts.text_as_html==false){this.text_as_html=opts.text_as_html}else{if(Config.text_as_html==true||Config.text_as_html==false){this.text_as_html=Config.text_as_html}else{this.text_as_html=true}}}},strval:function(a,b,c){if(a){return a}else{if(b){return b}else{return c}}},strarr:function(str){return eval("["+str+"]")},strreg:function(str){arr=this.strarr(str);return new RegExp(arr[0],arr[1])},strhnd:function(str){arr=this.strarr(str);return eval(arr[0])[arr[1]]}});Config.define=function(opts){if(opts.id){Config.id=opts.id}if(opts.log){Config.log=opts.log}if(opts.mode){Config.mode=opts.mode}if(opts.viewer){Config.viewer=opts.viewer}if(opts.param){Config.param=opts.param}if(opts.length){Config.length=opts.length}if(opts.images){Config.images=opts.length}if(opts.init_index){Config.init_index=opts.init_index}if(opts.images_loop==true||opts.images_loop==false){Config.images_loop=opts.images_loop}if(opts.text==true||opts.text==false){Config.text=opts.text}if(opts.page==true||opts.page==false){Config.page=opts.page}if(opts.window_images_loop==true||opts.window_images_loop==false){Config.window_images_loop=opts.window_images_loop}if(opts.view_images_loop==true||opts.window_images_loop==false){Config.view_images_loop=opts.view_images_loop}if(opts.window_text==true||opts.window_text==false){Config.window_text=opts.window_text}if(opts.view_text==true||opts.view_text==false){Config.view_text=opts.view_text}if(opts.window_page==true||opts.window_page==false){Config.window_page=opts.window_page}if(opts.view_page==true||opts.view_page==false){Config.view_page=opts.view_page}if(opts.open){Config.open=opts.open}if(opts.show){Config.show=opts.show}if(opts.close){Config.close=opts.close}if(opts.zoom){Config.zoom=opts.zoom}if(opts.restore){Config.restore=opts.restore}if(opts.click){Config.click=opts.click}if(opts.enable_filepath){Config.enable_filepath=opts.enable_filepath}if(opts.disable_filepath){Config.disable_filepath=opts.disable_filepath}if(opts.enable_filename){Config.enable_filename=opts.enable_filename}if(opts.disable_filename){Config.disable_filename=opts.disable_filename}if(opts.close_button_image){Config.close_button_image=opts.close_button_image}if(opts.prev_button_image){Config.prev_button_image=opts.prev_button_image}if(opts.next_button_image){Config.next_button_image=opts.next_button_image}if(opts.zoom_cursor){Config.zoom_cursor=opts.zoom_cursor}if(opts.zoom_cursor_image){Config.zoom_cursor_image=opts.zoom_cursor_image}if(opts.move_cursor){Config.move_cursor=opts.move_cursor}if(opts.move_cursor_image){Config.move_cursor_image=opts.move_cursor_image}if(opts.restore_cursor){Config.restore_cursor=opts.restore_cursor}if(opts.restore_cursor_image){Config.restore_cursor_image=opts.restore_cursor_image}if(opts.text_as_html==true||opts.text_as_html==false){Config.text_as_html=opts.text_as_html}};Config.define({init_index:1,images_loop:false,text:false,page:false,zoom_cursor:"pointer",move_cursor:"move",restore_cursor:"default"});var Dispatcher=Class.create(null,{_list:null,_element:null,init:function(element){Log.output("Initialize Dispatcher");this._list=[];if(element){this._element=element}},add:function(name,handler,original){if(!original){var original=handler}this._list.push({name:name,handler:handler,original:original});if(this._element){this._element.addEventListener(name,handler)}},remove:function(name,original){var handler;for(var p=0;p<this._list.length;p++){if(this._list[p].original==original){handler=this._list[p].handler;this._list.splice(p,1);break}}if(this._element&&handler){this._element.removeEventListener(name,handler)}}});if(!touches){var touches={}}touches.Touches=Class.create(null,{_element:null,_gesture_flag:false,_front_touch:null,_pinch_center:null,_scale:1,init:function(e){Log.output("Initialize Touches");var self=this;this._pinch_center={x:0,y:0};this._element=$(e)[0];this._element.addEventListener("gesturestart",function(e){self._gesture_flag=true;self._scale=e.scale});this._element.addEventListener("gesturechange",function(e){self._scale=e.scale});this._element.addEventListener("gestureend",function(e){self._gesture_flag=false;self._scale=e.scale});this._element.addEventListener("touchstart",function(e){self._front_touch=e.targetTouches[0]});this._element.addEventListener("touchmove",function(e){if(e.targetTouches.length>=2){self._pinch_center=self._calc_pinch_center(e.targetTouches)}self._front_touch=e.targetTouches[0]});this._element.addEventListener("touchend",function(e){})},gesture:function(){return this._gesture_flag},front_touch:function(){return this._front_touch},scale:function(){return this._scale},pinch_center:function(){return this._pinch_center},_calc_pinch_center:function(touches){var touch1=touches[0];var touch2=touches[1];return{x:touch1.pageX-(touch1.pageX-touch2.pageX)/2,y:touch1.pageY-(touch1.pageY-touch2.pageY)/2}}});var Doc={_dispatcher:null,_touches:null,init:function(){Log.output("Initialize Doc");this._dispatcher=new Dispatcher(document);this._touches=new touches.Touches(document)},touches:function(){return this._touches},addEventListener:function(name,handler,bubble){this._dispatcher.add(name,function(e){if(handler){handler(e)}},handler)},removeEventListener:function(name,handler){this._dispatcher.remove(name,handler)}};if(navigator.userAgent.indexOf("Safari")!=-1&&navigator.userAgent.indexOf("Mobile")!=-1){Doc.init()}var Frame=Class.create(null,{_frame:null,_viewer:null,_dispatcher:null,_scale:1,_basis_scale:1,_touches:null,init:function(parent){Log.output("Initialize Frame");this._frame=$("<div class='frame'/>");this._frame.css("overflow","hidden");this._frame.css("position","relative");if(parent){parent.append(this._frame)}this._dispatcher=new Dispatcher(this._frame[0]);this._touches=new touches.Touches(this._frame)},viewer:function(e){if(e){this._frame.append(e);this._viewer=e;this._frame.width(this._viewer.width());this._frame.height(this._viewer.height())}return this._viewer},element:function(){return this._frame},size:function(){return{width:this._frame.width(),height:this._frame.height()}},width:function(){return this._frame.width()},height:function(){return this._frame.height()},offset:function(){return this._frame.offset()},scale:function(s){if(s){this._scale=s}return this._scale},touches:function(){return this._touches},cursor:function(cursor,image){if(!cursor){cursor="auto"}if(image){this._frame.css("cursor","url("+image+"),"+cursor)}else{if(cursor){this._frame.css("cursor",cursor)}}return this._frame.css("cursor")},parent:function(){return this._frame.parent()},append:function(e){this._frame.append(e)},before:function(e){this._frame.before(e)},after:function(e){this._frame.after(e)},addEventListener:function(name,handler,bubble){var self=this;switch(name){case"pointerdown":name="touchstart";break}this._dispatcher.add(name,function(e){switch(name){case"gesturestart":self._scale=self._basis_scale*e.scale;break;case"gesturechange":self._scale=self._basis_scale*e.scale;break;case"gestureend":self._scale=self._basis_scale*e.scale;self._basis_scale=self._scale;break;case"touchstart":break;case"touchmove":break;case"touchend":break}if(handler){handler(e)}},handler)},removeEventListener:function(name,handler){this._dispatcher.remove(name,handler)}});var ImageViewer=Class.create(null,{_id:null,_viewer:null,_cursor_image:null,_mouse:null,init:function(id,opts){this._id=id;this._mouse={x:0,y:0};switch(opts.mode){case"view":this._viewer=new ViewMode(this,opts);break;case"window":this._viewer=new WindowMode(this,opts);break;default:throw new Error("Initialization Error");break}},show:function(index){this._viewer.show(index)},prev:function(){Log.output("show previous image");var index=this._viewer._index-1;if(this._viewer._opts.images_loop){if(index<0){index=this._viewer._opts.images.length-1}this._viewer.show(index)}else{if(index>=0){this._viewer.show(index)}}},next:function(){Log.output("show next image");var index=this._viewer._index+1;if(this._viewer._opts.images_loop){if(index>=this._viewer._opts.images.length){index=0}this._viewer.show(index)}else{if(index<this._viewer._opts.images.length){this._viewer.show(index)}}},bind:function(handlers){var opts=this._viewer._opts;if(handlers.open){opts.open=handlers.open}if(handlers.show){opts.show=handlers.show}if(handlers.close){opts.close=handlers.close}if(handlers.zoom){opts.zoom=handlers.zoom}if(handlers.restore){opts.restore=handlers.restore}if(handlers.click){opts.click=handlers.click}},_check_validity:function(url,opts){var validity=true;if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]}var filename=url.match(".+/(.+?).[a-z]+$")[1];var validity1=true;var validity2=true;var validity3=true;var validity4=true;var res;if(opts.enable_filepath){res=url.match(opts.enable_filepath);if(res&&res.length&&res.length>0){validity1=true}else{validity1=opts.enable_filepath.test(url)}}if(opts.disable_filepath){res=url.match(opts.disable_filepath);if(res&&res.length&&res.length>0){validity2=false}else{validity2=!opts.disable_filepath.test(url)}}if(opts.enable_filename){res=filename.match(opts.enable_filename);if(res&&res.length&&res.length>0){validity3=true}else{validity3=opts.enable_filename.test(filename)}}if(opts.disable_filename){res=filename.match(opts.disable_filename);if(res&&res.length&&res.length>0){validity4=false}else{validity4=!opts.disable_filename.test(filename)}}validity=(validity1&&validity2&&validity3&&validity4);Log.output("Image validity: "+url+" > "+validity);return validity},_create_data:function(id,images){var list=[];for(var p=0;p<images.length;p++){var data={};data.id=id;data.index=p+1;data.width=images[p].width[0];data.height=images[p].height[0];data.src=images[p].src;data.text=images[p].text;data.show_count=0;data.zoom_count=0;data.open_count=0;data.restore_count=0;data.click_count=0;list[p]=data}return list},_init_viewer:function(viewer,urls,recs,image_sizes,count,position){Log.output("init viewer");if(!position){var position="absolute"}var size={width:viewer.width(),height:viewer.height()};var init_size={width:viewer.width(),height:viewer.height()};var width=image_sizes[count].width;var height=image_sizes[count].height;var image_urlset=[];for(var p=0;p<urls.length;p++){var url=urls[p];var rec=recs[p];Log.output("REC!:"+rec);if(rec){if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}}image_urlset.push({url:url,rec:rec})}var url=image_urlset[count].url;var pos=viewer.offset();var position={x:pos.left,y:pos.top};var init_position={x:pos.left,y:pos.top};viewer.css("position","absolute");viewer.css("left",0);viewer.css("top",0);viewer.css("margin","0");viewer.css("padding","0");viewer.attr("src",url);viewer.attr("width",width);viewer.attr("height",height);Log.output("viewer url: "+url);Log.output("viewer size: ("+size.width+","+size.height+")");Log.output("viewer position: ("+position.x+","+position.y+")");Log.output("viewer Initial position: ("+init_position.x+","+init_position.y+")");return{size:size,init_size:init_size,position:position,init_position:init_position}},_init_frame:function(id,viewer,frame){var size={width:viewer.width(),height:viewer.height()};frame.css("overflow","hidden");frame.css("position","relative");frame.width(size.width);frame.height(size.height);size={width:size.width,height:size.height};org_size={width:size.width,height:size.height};return{frame:frame,size:size,org_size:org_size}},_init_page:function(frame,validity){var page=$("<p class='page'/>");frame.before(page);if(!validity){page.css("display","none")}return page},_init_text:function(frame,validity){var text=$("<p class='text'/>");text.css("width",frame.width());frame.after(text);if(!validity){text.css("display","none")}return text},_init_body:function(id,child){child.wrap("<div id='image-viewer-"+id+"'/>");return child.parent()},_update_page:function(element,from,to){element.empty();element.prepend(from+"/"+to)},_update_text:function(element,text,text_as_html){element.empty();if(text_as_html){element.prepend(text)}else{element.text(text)}},_get_cursor:function(opts){var data={};if(opts.zoom_cursor){data.zoom_cursor=opts.zoom_cursor}if(opts.zoom_cursor_image){data.zoom_cursor_image=opts.zoom_cursor_image}if(opts.move_cursor){data.move_cursor=opts.move_cursor}if(opts.move_cursor_image){data.move_cursor_image=opts.move_cursor_image}if(opts.restore_cursor){data.restore_cursor=opts.restore_cursor}if(opts.restore_cursor_image){data.restore_cursor_image=opts.restore_cursor_image}return data},_get_image:function(images,index){Log.output("get image");var sizes=[];var std_sizes=[];for(var p=0;p<images[index].width.length;p++){sizes[p]={width:images[index].width[p],height:images[index].height[p]}}for(var p=0;p<images[index].width.length;p++){std_sizes[p]={width:images[index].width[p],height:images[index].height[p]}}var urls=[];for(var p=0;p<images[index].width.length;p++){var url=images[index]["image"+(p+1)+"_src"];Log.output("url("+(p+1)+"):"+url);urls.push(url)}var recs=[];for(var p=0;p<images[index].width.length;p++){var rec=images[index]["image"+(p+1)+"_rec"];Log.output("rec("+(p+1)+"):"+rec);recs.push(rec)}var zoom_limit=sizes.length;for(var p=0;p<sizes.length;p++){Log.output("image size: ("+sizes[p].width+","+sizes[p].height+")")}for(var p=0;p<std_sizes.length;p++){Log.output("image standard size: ("+std_sizes[p].width+","+std_sizes[p].height+")")}return{sizes:sizes,std_sizes:std_sizes,urls:urls,recs:recs,zoom_limit:zoom_limit}},_use_image_cursor:function(cursor,images,frame){if(images.cur&&!$.support.htmlSerialize&&$.support.scriptEval||!$.support.opacity){frame.css("cursor","url("+images.cur+"),"+cursor)}else{if(images.src&&$.support.checkOn&&$.support.htmlSerialize&&window.globalStorage&&navigator.userAgent.indexOf("Mac")!=-1){if(!this._cursor_image){var cursor=$("<div class='cursor'/>");frame.parent().append(cursor);frame.css("cursor","none");cursor.css("cursor","none");cursor.css("position","absolute");cursor.css("background-image","url("+images.src+")");cursor.css("margin","0");cursor.css("padding","0");cursor.width(images.width);cursor.height(images.height);cursor.offset({left:this._mouse.x,top:this._mouse.y});this._cursor_image=cursor}}else{if(images.src){frame.css("cursor","url("+images.src+"),"+cursor)}}}},_dispatch_event:function(event,opts,data){var handler;switch(event){case"open":handler=opts.open;break;case"show":handler=opts.show;break;case"close":handler=opts.close;break;case"zoom":handler=opts.zoom;break;case"restore":handler=opts.restore;break;case"click":handler=opts.click;break;default:return}if(handler){Log.output("dispatch "+event+" event");handler(data)}},_preload:function(viewer,pool,zoom,image,cb){Log.output("preload image");if(!pool[zoom]){loader=$("<img class='viewer"+zoom+"' galleryimg='no' />");loader.css("position","absolute");var width=image.width;var height=image.height;var url=image.url;if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}loader.load(cb);loader.attr("width",viewer.width());loader.attr("height",viewer.height());var pos=viewer.position();loader.css("left",pos.left);loader.css("top",pos.top);loader.css("margin","0");loader.css("padding","0");loader.attr("src",url);loader.hide();viewer.after(loader);pool[zoom]=loader}},_preload_image:function(self){Log.output("preload image");if(!self._image_validity){return}var loader;if(self._viewer_pool[self._zoom_count]){for(var p=0;p<self._viewer_pool.length;p++){if(self._viewer_pool[p]){loader=self._viewer_pool[p];if(self._zoom_count==p){self._viewer.after(loader);loader.attr("width",self._viewer.width());loader.attr("height",self._viewer.height());var pos={};pos.left=Number(self._viewer.css("left").replace("px",""));pos.top=Number(self._viewer.css("top").replace("px",""));loader.css("left",pos.left);loader.css("top",pos.top);loader.css("display","");self._loader=loader}else{self._viewer.before(loader);loader.hide()}}}}else{loader=$("<img class='viewer"+self._zoom_count+"' galleryimg='no' />");loader.css("position","absolute");var width=self._image_std_sizes[self._zoom_count].width;var height=self._image_std_sizes[self._zoom_count].height;var url=self._image_urls[self._zoom_count];var rec=self._image_recs[self._zoom_count];if(rec){if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}}Log.output("url:"+url);loader.attr("width",self._viewer.width());loader.attr("height",self._viewer.height());var pos=self._viewer.position();loader.css("left",pos.left);loader.css("top",pos.top);loader.css("margin","0");loader.css("padding","0");loader.attr("src",url);loader.hide();self._viewer.after(loader);if(self._loader){self._loader.hide()}self._loader=loader;self._viewer_pool[self._zoom_count]=loader}},_move_image:function(self,x,y){if(!self._image_validity){return}if(self._animation){clearInterval(self._animation);self._animation=null;self._viewer.attr({width:self._viewer_size.width,height:self._viewer_size.height});self._viewer.css({left:self._viewer_position.x,top:self._viewer_position.y});if(self._loader){self._loader.attr({width:self._viewer_size.width,height:self._viewer_size.height});self._loader.css({left:self._viewer_position.x,top:self._viewer_position.y});self._viewer.after(self._loader)}}var pos=self._viewer.position();self._position_delta={x:x-self._mouse.x,y:y-self._mouse.y};pos.left+=self._position_delta.x;pos.top+=self._position_delta.y;Log.scan(self._position_delta);if(pos.left<=0&&pos.top<=0&&Math.abs(pos.left)<=(self._viewer_size.width-self._frame_size.width)&&Math.abs(pos.top)<=(self._viewer_size.height-self._frame_size.height)){self._viewer.css({left:pos.left,top:pos.top});if(self._loader){self._viewer.before(self._loader);self._loader.css({left:pos.left,top:pos.top})}}self._mouse={x:x,y:y}},_zoom_image:function(self,x,y){if(!self._image_validity){return}var owner=this;var loader;if(self._viewer_pool.length){for(var p=0;p<self._viewer_pool.length;p++){if(self._viewer_pool[p]){loader=self._viewer_pool[p];loader.css("display","none");self._viewer.before(loader)}}}if(self._animation){clearInterval(self._animation);self._animation=null;self._viewer.attr("width",self._viewer_size.width);self._viewer.attr("height",self._viewer_size.height);self._viewer.css("left",self._viewer_position.left);self._viewer.css("top",self._viewer_position.top);if(self._loader){self._loader.attr("width",self._viewer_size.width);self._loader.attr("height",self._viewer_size.height);self._loader.css("left",self._viewer_position.left);self._loader.css("top",self._viewer_position.top)}}var viewer_size={width:self._viewer.width(),height:self._viewer.height()};var offset={left:Number(self._viewer.css("left").replace("px","")),top:Number(self._viewer.css("top").replace("px",""))};var pos=self._viewer.offset();var original_position={x:offset.left,y:offset.top};var original_point={x:x-pos.left,y:y-pos.top};var ratio={x:original_point.x/viewer_size.width,y:original_point.y/viewer_size.height};var width=self._image_std_sizes[self._zoom_count].width;var height=self._image_std_sizes[self._zoom_count].height;var point={x:width*ratio.x,y:height*ratio.y};self._viewer_size={width:width,height:height};self._viewer_position={x:original_point.x+original_position.x-point.x,y:original_point.y+original_position.y-point.y};var delta_size={width:self._viewer_size.width-viewer_size.width,height:self._viewer_size.height-viewer_size.height};var delta_position={x:self._viewer_position.x-original_position.x,y:self._viewer_position.y-original_position.y};Log.output("current viewer position ("+original_position.x+","+original_position.y+")");Log.output("mouse position ("+x+","+y+")");Log.output("relative mouse position ("+original_point.x+","+original_point.y+")");Log.output("position ratio ("+ratio.x+","+ratio.y+")");Log.output("current viewer size ("+viewer_size.width+","+viewer_size.height+")");Log.output("next viewer size ("+self._viewer_size.width+","+self._viewer_size.height+")");Log.output("delta size ("+delta_size.width+","+delta_size.height+")");Log.output("next position ("+self._viewer_position.x+","+self._viewer_position.y+")");Log.output("delta position ("+delta_position.x+","+delta_position.y+")");self._zoom_count++;var flag=true;self._animation_flag=true;self._animation=setInterval(function(){var x;var y;var width;var height;if(self._loader){self._loader.hide()}if(delta_size.width>1){delta_size.width=delta_size.width/2;viewer_size.width+=delta_size.width;width=viewer_size.width}else{if(delta_size.width>0){delta_size.width=0;width=self._viewer_size.width}}if(delta_size.height>1){delta_size.height=delta_size.height/2;viewer_size.height+=delta_size.height;height=viewer_size.height}else{if(delta_size.height>0){delta_size.height=0;height=self._viewer_size.height}}if(Math.abs(delta_position.x)>1){delta_position.x=delta_position.x/2;original_position.x+=delta_position.x;x=Math.round(original_position.x)}else{delta_position.x=0;x=self._viewer_position.x}if(Math.abs(delta_position.y)>1){delta_position.y=delta_position.y/2;original_position.y+=delta_position.y;y=Math.round(original_position.y)}else{delta_position.y=0;y=self._viewer_position.y}var viewer=self._viewer[0];self._viewer.css({left:x,top:y});self._viewer.attr({width:width,height:height});if(flag&&self._loader){}if((delta_position.x==0&&delta_position.y==0)&&(delta_size.width==0&&delta_size.height==0)){clearInterval(self._animation);self._animation=null;self._animation_flag=false;if(self._loader){var loader=self._loader[0];if(loader){loader.width=width;loader.height=height}self._loader.css({left:x,top:y});self._viewer.after(self._loader);self._loader.show()}}},1);self._init_scale_flag=false;self._data[self._index].zoom_count++;self._data[self._index].width=self._image_std_sizes[self._zoom_count-1].width;self._data[self._index].height=self._image_std_sizes[self._zoom_count-1].height;if(self._opts.zoom){owner._dispatch_event("zoom",self._opts,self._data[self._index])}},_restore_image:function(self){var owner=this;if(self._animation){clearInterval(self._animation);self._animation=null}self._zoom_count=0;var width=self._image_std_sizes[self._zoom_count].width;var height=self._image_std_sizes[self._zoom_count].height;self._zoom_count++;self._loader=null;self._position_delta={x:0,y:0};self._viewer_size={width:self._viewer_init_size.width,height:self._viewer_init_size.height};self._viewer_position={x:self._viewer_init_position.x,y:self._viewer_init_position.y};self._viewer.css("position","absolute");self._viewer.css("left",0);self._viewer.css("top",0);self._viewer.attr("width",width);self._viewer.attr("height",height);Log.output("viewer size: ("+self._viewer_size.width+","+self._viewer_size.height+")");Log.output("viewer position: ("+self._viewer_position.x+","+self._viewer_position.y+")");var loader;if(self._viewer_pool.length){for(var p=0;p<self._viewer_pool.length;p++){if(self._viewer_pool[p]){loader=self._viewer_pool[p];loader.css("display","none");self._viewer.before(loader)}}}self._data[self._index].restore_count++;self._data[self._index].width=self._image_std_sizes[0].width;self._data[self._index].height=self._image_std_sizes[0].height;if(self._opts.restore){self._owner._dispatch_event("restore",self._opts,self._data[self._index])}},_remove_cache:function(self){if(self._viewer_pool[self._zoom_count]){for(var p=0;p<self._viewer_pool.length;p++){if(self._viewer_pool[p]){loader=self._viewer_pool[p];loader.remove()}}}self._viewer_pool=[]},_bind_events:function(self){var owner=this;var _body_mouse_handler=function(e){owner._mouse={x:e.pageX,y:e.pageY};if(owner._cursor_image){var mpos={left:e.pageX,top:e.pageY};var vpos=self._frame.offset();var vsize={width:self._frame.width(),height:self._frame.height()};if(mpos.left<vpos.left||mpos.left>vpos.left+vsize.width||mpos.top<vpos.top||mpos.top>vpos.top+vsize.height){owner._cursor_image.remove();owner._cursor_image=null;self._frame.css("cursor","default")}else{var width=owner._cursor_image.width();var height=owner._cursor_image.height();owner._cursor_image.offset({left:e.pageX,top:e.pageY})}}};$(document).bind("mousemove",_body_mouse_handler);var _mouseover_handler=function(e){e.preventDefault();if(self._image_validity){if(self._zoom_count<self._zoom_limit){if(self._zoom_cursor_image&&(self._zoom_cursor_image.src||self._zoom_cursor_image.cur)){owner._use_image_cursor(self._zoom_cursor,self._zoom_cursor_image,self._frame)}else{self._frame.css("cursor",self._zoom_cursor)}}else{if(self._restore_cursor_image&&(self._restore_cursor_image.src||self._restore_cursor_image.cur)){owner._use_image_cursor(self._restore_cursor,self._restore_cursor_image,self._frame)}else{self._frame.css("cursor",self._restore_cursor)}}}else{if(owner._cursor_image){owner._cursor_image.remove();owner._cursor_image=null}self._frame.css("cursor","")}};var _mousedown_handler=function(e){Log.output("mouse down");if(!owner._cursor_image){e.preventDefault();self._moving_flag=false;self._down_mouse={x:e.pageX,y:e.pageY};self._mouse={x:e.pageX,y:e.pageY};if(self._zoom_count<self._zoom_limit){self._preload_image()}$(document).unbind("mousemove",_mousemove_handler);$(document).unbind("mouseup",_mouseup_handler);$(document).bind("mousemove",_mousemove_handler);$(document).bind("mouseup",_mouseup_handler)}};var _mousemove_handler=function(e){e.preventDefault();self._moving_flag=true;if(self._zoom_count>0){if(self._image_validity){if(self._move_cursor_image&&(self._move_cursor_image.src||self._move_cursor_image.cur)){owner._use_image_cursor(self._move_cursor,self._move_cursor_image,self._frame)}else{if(owner._cursor_image){owner._cursor_image.remove();owner._cursor_image=null}self._frame.css("cursor",self._move_cursor)}}else{if(owner._cursor_image){owner._cursor_image.remove();owner._cursor_image=null}self._frame.css("cursor","default")}self._move_image(e.pageX,e.pageY);if(self._loader){self._loader.css("display","");self._viewer.after(self.loader)}}};var _mouseup_handler=function(e){Log.output("mouse up");e.preventDefault();$(document).unbind("mousemove",_mousemove_handler);$(document).unbind("mouseup",_mouseup_handler);var delta_x=self._down_mouse.x-self._mouse.x;var delta_y=self._down_mouse.y-self._mouse.y;if(!self._moving_flag||(delta_x==0&&delta_y==0)){if(self._zoom_count<self._zoom_limit){self._zoom_image(self._down_mouse.x,self._down_mouse.y)}else{self._restore_image()}}if(self._loader){self._viewer.after(self._loader);self._loader.css("display","")}if(!self._moving_flag){self._data[self._index].click_count++;if(self._opts.click){owner._dispatch_event("click",self._opts,self._data[self._index])}}if(owner._cursor_image){owner._cursor_image.remove();owner._cursor_image=null;self._frame.css("cursor","default")}if(self._image_validity){if(self._zoom_count<self._zoom_limit){if(self._zoom_cursor_image&&(self._zoom_cursor_image.src||self._zoom_cursor_image.cur)){owner._use_image_cursor(self._zoom_cursor,self._zoom_cursor_image,self._frame)}else{self._frame.css("cursor",self._zoom_cursor)}}else{if(self._restore_cursor_image&&(self._restore_cursor_image.src||self._restore_cursor_image.cur)){owner._use_image_cursor(self._restore_cursor,self._restore_cursor_image,self._frame)}else{self._frame.css("cursor",self._restore_cursor)}}}self._moving_flag=false};var _parent_mousedown_handler=function(e){if(owner._cursor_image){Log.output("mouse down from paremt");e.preventDefault();self._moving_flag=false;self._down_mouse={x:e.pageX,y:e.pageY};self._mouse={x:e.pageX,y:e.pageY};if(self._zoom_count<self._zoom_limit){self._preload_image()}$(document).unbind("mousemove",_mousemove_handler);$(document).unbind("mouseup",_mouseup_handler);$(document).bind("mousemove",_mousemove_handler);$(document).bind("mouseup",_mouseup_handler)}};self._frame.bind("mouseover",_mouseover_handler);self._frame.bind("mousedown",_mousedown_handler);self._frame.parent().bind("mousedown",_parent_mousedown_handler);$(document).bind("mousedown",function(){Log.output("mouse down")})}});var ViewMode=Class.create(null,{_owner:null,_opts:null,_index:0,_id:null,_body:null,_viewer:null,_viewer_size:null,_viewer_init_size:null,_viewer_position:null,_viewer_init_position:null,_frame:null,_frame_size:null,_org_frame_size:null,_text:null,_page:null,_image_validity:true,_image_urls:null,_image_recs:null,_image_sizes:null,_image_std_sizes:null,_loader:null,_zoom_count:0,_zoom_limit:0,_zoom_cursor:null,_zoom_cursor_image:null,_move_cursor:null,_move_cursor_image:null,_viewer_pool:null,_position_delta:null,_down_mouse:null,_init_flag:false,_open_flag:false,_moving_flag:false,_animation_flag:false,_down_mouse:null,_mouse:null,_data:null,init:function(owner,opts){Log.output("initialize view");this._init(owner,opts);this.show(opts.init_index);this._init_flag=true},show:function(index){Log.output("show (index:"+index+")");var self=this;this._index=index;if(this._init_flag){this._restore_image();this._remove_cache()}this._zoom_count=0;this._update();this._zoom_count=1;this._data[this._index].show_count++;if(this._opts.show){this._owner._dispatch_event("show",this._opts,this._data[this._index])}},prev:function(){this._owner.prev()},next:function(){this._owner.next()},_init:function(owner,opts){this._owner=owner;this._opts=opts;this._index=0;this._id=opts.id;this._viewer=this._opts.viewer;this._viewer.attr("galleryimg","no");this._viewer_pool=[null];this._position_delta={x:0,y:0};this._down_mouse=null;this._data=this._owner._create_data(this._id,this._opts.images);this._init_cursor();this._init_frame(this._id,this._viewer);this._bind_events()},_init_cursor:function(){var cursor=this._owner._get_cursor(this._opts);if(cursor.zoom_cursor){this._zoom_cursor=cursor.zoom_cursor}if(cursor.zoom_cursor_image){this._zoom_cursor_image=cursor.zoom_cursor_image}if(cursor.move_cursor){this._move_cursor=cursor.move_cursor}if(cursor.move_cursor_image){this._move_cursor_image=cursor.move_cursor_image}if(cursor.restore_cursor){this._restore_cursor=cursor.restore_cursor}if(cursor.restore_cursor_image){this._restore_cursor_image=cursor.restore_cursor_image}},_init_frame:function(id,viewer){var size={width:viewer.width(),height:viewer.height()};viewer.wrap("<div class='frame'/>");var frame=viewer.parent();var data=this._owner._init_frame(id,viewer,frame);this._frame=data.frame;this._frame_size=data.size;this._org_frame_size=data.org_size;this._body=this._owner._init_body(id,frame);this._page=this._owner._init_page(frame,this._opts.page);this._text=this._owner._init_text(frame,this._opts.text)},_update:function(){Log.output("update");var url=this._opts.images[this._index]["src"];this._image_validity=this._owner._check_validity(url,this._opts);var image=this._owner._get_image(this._opts.images,this._index);this._image_sizes=image.sizes;this._image_std_sizes=image.std_sizes;this._image_urls=image.urls;this._image_recs=image.recs;this._zoom_limit=image.zoom_limit;var viewer=this._owner._init_viewer(this._viewer,this._image_urls,this._image_recs,this._image_std_sizes,this._zoom_count);this._viewer_size=viewer.size;this._viewer_init_size=viewer.init_size;this._viewer_position=viewer.position;this._viewer_init_position=viewer.init_position;this._owner._update_page(this._page,(this._index+1),this._opts.images.length);this._owner._update_text(this._text,this._opts.images[this._index].text,this._opts.text_as_html)},_preload_image:function(){this._owner._preload_image(this)},_move_image:function(x,y){this._owner._move_image(this,x,y)},_zoom_image:function(x,y){if(this._opts.open&&!this._open_flag){this._data[this._index].open_count++;this._owner._dispatch_event("open",this._opts,this._data[this._index])}this._open_flag=true;this._owner._zoom_image(this,x,y)},_restore_image:function(){this._owner._restore_image(this)},_remove_cache:function(){this._owner._remove_cache(this)},_bind_events:function(){this._owner._bind_events(this)}});var WindowMode=Class.create(null,{_owner:null,_opts:null,_index:0,_id:null,_viewer:null,_viewer_size:null,_viewer_init_size:null,_viewer_position:null,_viewer_init_position:null,_frame:null,_frame_size:null,_org_frame_size:null,_iframe:null,_text:null,_page:null,_image_validity:true,_image_urls:null,_image_recs:null,_image_sizes:null,_image_std_sizes:null,_loader:null,_zoom_count:0,_zoom_limit:0,_zoom_cursor:null,_zoom_cursor_image:null,_move_cursor:null,_move_cursor_image:null,_restore_cursor:null,_restore_cursor_image:null,_close_button:null,_prev_button:null,_next_button:null,_viewer_pool:null,_position_delta:null,_down_mouse:null,_init_flag:false,_open_flag:false,_moving_flag:false,_animation_flag:false,_down_mouse:null,_mouse:null,_data:null,init:function(owner,opts){Log.output("Initialize Window mode");this._owner=owner;this._opts=opts},show:function(index){Log.output("Show image (index:"+index+")");var self=this;if(this._init_flag){this._index=index;this._restore_image();this._remove_cache()}else{this._init();this._init_flag=true;this._index=index}this._viewer.css("display","none");this._zoom_count=0;this._update();this._zoom_count=1;if(this._body.css("display")=="none"){this._body.css("display","");this._reposit_display()}this._stretch_bg();if(this._opts.open&&!this._open_flag){this._data[this._index].open_count++;this._owner._dispatch_event("open",this._opts,this._data[this._index])}this._open_flag=true;this._data[this._index].show_count++;if(this._opts.show){this._owner._dispatch_event("show",this._opts,this._data[this._index])}this._viewer.css("display","")},prev:function(){this._owner.prev()},next:function(){this._owner.next()},_close:function(){this._restore_image();this._remove_cache();this._body.css("display","none");if(this._opts.close){this._owner._dispatch_event("close",this._opts,this._data[this._index])}},_init:function(){this._index=0;this._id=this._opts.id;this._viewer_pool=[null];this._position_delta={x:0,y:0};this._down_mouse=null;this._data=this._owner._create_data(this._id,this._opts.images);this._init_cursor();this._create_env(this._opts);this._zoom_count=0;this._update();this._zoom_count=1;this._bind_events()},_create_env:function(opts){var image=opts.images[0];var image_size={width:image.width[0],height:image.height[0]};$("body").height("100%");$("html").height("100%");var bg=$("<div class='background'/>");bg.css("position","absolute");bg.css("left",0);bg.css("top",0);bg.css("background-color","#000000");bg.css("opacity",0.6);bg.css("filter","alpha(opacity=60)");bg.css("width","100%");bg.css("height",$(document).height());$("body").append(bg);var display=$("<div class='display'/>");display.css("position","absolute");display.css("left","50%");display.css("top",$(document).height()/2);display.css("padding",9);if(this._opts.prev_button_image&&this._opts.prev_button_image.src){display.css("padding-left",this._opts.prev_button_image.width)}if(this._opts.next_button_image&&this._opts.next_button_image.src){display.css("padding-right",this._opts.next_button_image.width)}display.css("background-color","white");bg.after(display);var frame=$("<div class='frame'/>");var viewer=$("<img galleryimg='no'/>");display.append(frame);frame.append(viewer);viewer.attr("width",image_size.width);viewer.attr("height",image_size.height);var close;if(this._opts.close_button_image&&this._opts.close_button_image.src){var src=this._opts.close_button_image.src;var width=this._opts.close_button_image.width;var height=this._opts.close_button_image.height;close=jQuery("<div class='close'/>");close.css("background","url("+src+") no-repeat");close.css("width",width);close.css("height",height);close.css("position","absolute");close.css("left","100%");close.css("top",0);close.css("cursor","pointer");close.css("margin-left",-width/2);close.css("margin-top",-height/2);frame.after(close);this._closebtn=close}if(opts.images&&opts.images.length>1){var prev;if(this._opts.prev_button_image&&this._opts.prev_button_image.src){var src=this._opts.prev_button_image.src;var width=this._opts.prev_button_image.width;var height=this._opts.prev_button_image.height;prev=jQuery("<div class='prev'/>");prev.css("background","url("+src+") no-repeat");prev.css("width",width);prev.css("height",height);prev.css("position","absolute");prev.css("left",0);prev.css("top","50%");prev.css("cursor","pointer");prev.css("margin-left",0);prev.css("margin-top",0);frame.after(prev);this._prevbtn=prev}var next;if(this._opts.next_button_image&&this._opts.next_button_image.src){var src=this._opts.next_button_image.src;var width=this._opts.next_button_image.width;var height=this._opts.next_button_image.height;next=jQuery("<div class='next'/>");next.css("background","url("+src+") no-repeat");next.css("width",width);next.css("height",height);next.css("position","absolute");next.css("left","100%");next.css("top","50%");next.css("cursor","pointer");next.css("margin-left",-width);next.css("margin-top",0);frame.after(next);this._nextbtn=next}}var data=this._owner._init_frame(opts.id,viewer,frame);this._frame=data.frame;this._frame_size=data.size;this._org_frame_size=data.org_size;this._page=this._owner._init_page(frame,this._opts.page);this._text=this._owner._init_text(frame,this._opts.text);var body=this._owner._init_body(opts.id,bg);body.css("position","absolute");body.css("left",0);body.css("top",0);body.css("width","100%");body.css("height",$(document).height());body.append(display);if(!$.support.opacity&&!$.support.style&&(typeof document.documentElement.style.maxHeight=="undefined")){var iframe=$("<iframe/>");iframe.css("position","absolute");iframe.css("left",0);iframe.css("top",0);iframe.css("border-width",0);iframe.css("filter","alpha(opacity=60)");iframe.css("width",$(document).width());iframe.css("height",$(document).height());body.prepend(iframe);this._iframe=iframe}this._body=body;this._bg=bg;this._display=display;this._frame=frame;this._viewer=viewer;if(close){this._close_button=close}if(prev){this._prev_button=prev}if(next){this._next_button=next}this._body.css("display","none")},_init_cursor:function(){var cursor=this._owner._get_cursor(this._opts);if(cursor.zoom_cursor){this._zoom_cursor=cursor.zoom_cursor}if(cursor.zoom_cursor_image){this._zoom_cursor_image=cursor.zoom_cursor_image}if(cursor.move_cursor){this._move_cursor=cursor.move_cursor}if(cursor.move_cursor_image){this._move_cursor_image=cursor.move_cursor_image}if(cursor.restore_cursor){this._restore_cursor=cursor.restore_cursor}if(cursor.restore_cursor_image){this._restore_cursor_image=cursor.restore_cursor_image}},_update:function(){Log.output("update");var url=this._opts.images[this._index]["src"];this._image_validity=this._owner._check_validity(url,this._opts);var image=this._owner._get_image(this._opts.images,this._index);this._image_sizes=image.sizes;this._image_std_sizes=image.std_sizes;this._image_urls=image.urls;this._image_recs=image.recs;this._zoom_limit=image.zoom_limit;var viewer=this._owner._init_viewer(this._viewer,this._image_urls,this._image_recs,this._image_std_sizes,this._zoom_count,"relative");this._viewer_size=viewer.size;this._viewer_init_size=viewer.init_size;this._viewer_position=viewer.position;this._viewer_init_position=viewer.init_position;this._owner._update_page(this._page,(this._index+1),this._opts.images.length);this._owner._update_text(this._text,this._opts.images[this._index].text,this._opts.text_as_html)},_preload_image:function(){this._owner._preload_image(this)},_move_image:function(x,y){this._owner._move_image(this,x,y)},_zoom_image:function(x,y){this._owner._zoom_image(this,x,y)},_restore_image:function(){this._owner._restore_image(this)},_remove_cache:function(){this._viewer.remove();this._viewer=$("<img galleryimg='no'/>");this._frame.append(this._viewer);this._owner._remove_cache(this)},_stretch_bg:function(){this._bg.css("width",$(document).width());this._bg.css("height",$(document).height());if(this._iframe){this._iframe.css("width",$(document).width());this._iframe.css("height",$(document).height())}},_reposit_display:function(){var winWidth=$(window).width();var winHeight=$(window).height();var scrollLeft=$(window).scrollLeft();var scrollTop=$(window).scrollTop();var displayWidth=this._display.width();var displayHeight=this._display.height();Log.output("Window width:"+winWidth);Log.output("Window height:"+winHeight);Log.output("Scroll left:"+scrollLeft);Log.output("Scroll top:"+scrollTop);Log.output("Display width:"+displayWidth);Log.output("Display height:"+displayHeight);var left=scrollLeft+winWidth/2-displayWidth/2;var top=scrollTop+winHeight/2-displayHeight/2;if(this._closebtn&&top<(scrollTop+this._closebtn.height()/2+5)){top=scrollTop+this._closebtn.height()/2+5}else{if(top<scrollTop){top=scrollTop}}Log.output("Display left:"+left);Log.output("Display top:"+top);this._display.css("left",left);this._display.css("top",top)},_bind_events:function(){var self=this;$(window).bind("resize",function(e){self._stretch_bg();self._reposit_display()});this._bg.bind("click",function(e){self._close()});if(this._close_button){this._close_button.bind("click",function(){var src=self._opts.close_button_image.src;self._close_button.css("background","url("+src+") no-repeat");self._close()});this._close_button.bind("mouseover",function(){var src=self._opts.close_button_image.hover;self._close_button.css("background","url("+src+") no-repeat")});this._close_button.bind("mouseleave",function(){var src=self._opts.close_button_image.src;self._close_button.css("background","url("+src+") no-repeat")})}if(this._prev_button){this._prev_button.bind("click",function(){var src=self._opts.prev_button_image.src;self._prev_button.css("background","url("+src+") no-repeat");self.prev()});this._prev_button.bind("mouseover",function(){var src=self._opts.prev_button_image.hover;self._prev_button.css("background","url("+src+") no-repeat")});this._prev_button.bind("mouseleave",function(){var src=self._opts.prev_button_image.src;self._prev_button.css("background","url("+src+") no-repeat")})}if(this._next_button){this._next_button.bind("click",function(){var src=self._opts.next_button_image.src;self._next_button.css("background","url("+src+") no-repeat");self.next()});this._next_button.bind("mouseover",function(){var src=self._opts.next_button_image.hover;self._next_button.css("background","url("+src+") no-repeat")});this._next_button.bind("mouseleave",function(){var src=self._opts.next_button_image.src;self._next_button.css("background","url("+src+") no-repeat")})}this._owner._bind_events(this)}});var iphone={};iphone.ImageViewer=Class.create(null,{_mode:null,_config:null,_viewer_info:null,_images:null,_loader:null,_current_pointer:null,_move_position:null,_zoom_cb:null,init:function(id,config){Log.output("Initialize ImageViewer for iPhone > "+id);Log.output("User agent:"+navigator.userAgent);this._id=id;this._move_position={x:0,y:0};this._config=config;this._images=[];switch(config.mode){case"view":this._mode=new iphone.ViewMode(this,config);break;case"window":this._mode=new iphone.WindowMode(this,config);break;default:throw new Error("Initialization Error");break}if(this._mode){this._mode.build();this.build()}},build:function(){this._bind_events()},frame:function(){return this._mode.frame()},viewer:function(){return this._mode.viewer()},loader:function(e){if(e){this._loader=e}return this._loader},show:function(index){this._mode.show(index)},prev:function(){Log.output("Show previous image");var index=this._mode._index-1;if(this._config.images_loop){if(index<0){index=this._config.images.length-1}this._mode.show(index)}else{if(index>=0){this._mode.show(index)}}},next:function(){Log.output("Show next image");var index=this._mode._index+1;if(this._config.images_loop){if(index>=this._config.images.length){index=0}this._mode.show(index)}else{if(index<this._config.images.length){this._mode.show(index)}}},bind:function(handlers){var opts=this._config;if(handlers.open){opts.open=handlers.open}if(handlers.show){opts.show=handlers.show}if(handlers.close){opts.close=handlers.close}if(handlers.zoom){opts.zoom=handlers.zoom}if(handlers.restore){opts.restore=handlers.restore}if(handlers.click){opts.click=handlers.click}},_check_validity:function(url,opts){var validity=true;if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]}var filename=url.match(".+/(.+?).[a-z]+$")[1];var validity1=true;var validity2=true;var validity3=true;var validity4=true;var res;if(opts.enable_filepath){res=url.match(opts.enable_filepath);if(res&&res.length&&res.length>0){validity1=true}else{validity1=opts.enable_filepath.test(url)}}if(opts.disable_filepath){res=url.match(opts.disable_filepath);if(res&&res.length&&res.length>0){validity2=false}else{validity2=!opts.disable_filepath.test(url)}}if(opts.enable_filename){res=filename.match(opts.enable_filename);if(res&&res.length&&res.length>0){validity3=true}else{validity3=opts.enable_filename.test(filename)}}if(opts.disable_filename){res=filename.match(opts.disable_filename);if(res&&res.length&&res.length>0){validity4=false}else{validity4=!opts.disable_filename.test(filename)}}validity=(validity1&&validity2&&validity3&&validity4);Log.output("Image validity: "+url+" > "+validity);return validity},_create_data:function(id,images){var list=[];for(var p=0;p<images.length;p++){var data={};data.id=id;data.index=p+1;data.width=images[p].width[0];data.height=images[p].height[0];data.src=images[p].src;data.text=images[p].text;data.show_count=0;data.zoom_count=0;data.open_count=0;data.restore_count=0;data.click_count=0;list[p]=data}return list},_init_viewer:function(viewer,urls,recs,image_sizes,count,position){Log.output("init viewer");if(!position){var position="absolute"}var size={width:viewer.attr("width"),height:viewer.attr("height")};var init_size={width:viewer.attr("width"),height:viewer.attr("height")};var width=image_sizes[count].width;var height=image_sizes[count].height;var image_urlset=[];for(var p=0;p<urls.length;p++){var url=urls[p];var rec=recs[p];Log.output("REC!:"+rec);if(rec){if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}}image_urlset.push({url:url,rec:rec})}var url=image_urlset[count].url;var pos=viewer.offset();if(parseFloat(((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent))||[0,"4_2"])[1].replace("_","."))<4.1){if(navigator.userAgent.indexOf("4.0.4")!=-1){pos.left-=window.scrollX;pos.top-=window.scrollY}}var position={x:pos.left,y:pos.top};var init_position={x:pos.left,y:pos.top};viewer.css({position:"absolute",left:0,top:0});viewer.css("margin","0");viewer.css("padding","0");viewer.attr({src:url,width:width,height:height});this._viewer_info={size:size,init_size:init_size,position:position,init_position:init_position}},_init_page:function(frame,validity){var page=$("<p class='page'/>");frame.before(page);if(!validity){page.css("display","none")}return page},_init_text:function(frame,validity){var text=$("<p class='text'/>");text.css("width",frame.width());frame.after(text);if(!validity){text.css("display","none")}return text},_init_body:function(id,child){child.wrap("<div id='image-viewer-"+id+"'/>");return child.parent()},_update_page:function(element,from,to){element.empty();element.prepend(from+"/"+to)},_update_text:function(element,text,text_as_html){element.empty();if(text_as_html){element.prepend(text)}else{element.text(text)}},_get_cursor:function(opts){var data={};if(opts.zoom_cursor){data.zoom_cursor=opts.zoom_cursor}if(opts.zoom_touch_image){data.zoom_touch_image=opts.zoom_touch_image}if(opts.move_cursor){data.move_cursor=opts.move_cursor}if(opts.move_touch_image){data.move_touch_image=opts.move_touch_image}return data},_get_image:function(images,index){var sizes=[];var std_sizes=[];for(var p=0;p<images[index].width.length;p++){sizes[p]={width:images[index].width[p],height:images[index].height[p]}}for(var p=0;p<images[index].width.length;p++){std_sizes[p]={width:images[index].width[p],height:images[index].height[p]}}var urls=[];for(var p=0;p<images[index].width.length;p++){var url=images[index]["image"+(p+1)+"_src"];Log.output("url("+(p+1)+"):"+url);urls.push(url)}var recs=[];for(var p=0;p<images[index].width.length;p++){var rec=images[index]["image"+(p+1)+"_rec"];Log.output("rec("+(p+1)+"):"+rec);recs.push(rec)}var zoom_limit=sizes.length;return{sizes:sizes,std_sizes:std_sizes,urls:urls,recs:recs,zoom_limit:zoom_limit}},_use_touch_image:function(name,images,touch){if(!this._touch_image){var image=$("<div class='cursor'/>");this.frame().append(image);image.css("position","absolute");image.css("background-image","url("+images.src+")");image.css("margin","0");image.css("padding","0");image.width(images.width);image.height(images.height);var pos={x:touch.pageX,y:touch.pageY};var delta=0;if(navigator.userAgent.indexOf("iPad")!=-1){delta=-50}else{delta=-100}if(parseFloat(((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent))||[0,"4_2"])[1].replace("_","."))<4.1){if(navigator.userAgent.indexOf("4.0.4")!=-1){pos.x+=window.scrollX;pos.y+=window.scrollY}}image.offset({left:pos.x,top:pos.y+delta});this._touch_image={name:name,image:image}}},_dispatch_event:function(event,opts,data){var handler;switch(event){case"open":handler=opts.open;break;case"show":handler=opts.show;break;case"close":handler=opts.close;break;case"zoom":handler=opts.zoom;break;case"restore":handler=opts.restore;break;case"click":handler=opts.click;break;default:return}if(handler){handler(data)}},_preload:function(viewer,pool,zoom,image,cb){Log.output("Preload Image");return;if(!pool[zoom]){loader=$("<img class='viewer"+zoom+"' galleryimg='no' />");loader.css("position","absolute");var width=image.width;var height=image.height;var url=image.url;if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}loader.load(cb);loader.attr({width:viewer.width(),height:viewer.height()});pos=viewer.position();loader.css({left:pos.left,top:pos.top,display:"none"});loader.css("margin","0");loader.css("padding","0");loader.attr("src",url);viewer.after(loader);pool[zoom]=loader}},_preload_image:function(){if(!this._mode._image_validity){return}var self=this;var viewer=this.viewer();var sizes=this._mode._image_std_sizes;var pool=this._mode._viewer_pool;var count=this._mode._zoom_count;var loader;if(this._mode._viewer_pool[count]){Log.output("Local image");for(var p=0;p<pool.length;p++){if(pool[p]){loader=pool[p];if(count==p){viewer.after(loader);loader.attr({width:viewer.width(),height:viewer.height()});var pos=viewer.position();loader.css({left:pos.left,top:pos.top});loader.show();self.loader(loader)}else{viewer.before(loader);loader.hide()}}}}else{Log.output("Preload image index:"+count);loader=$("<img class='viewer"+count+"' />");loader.css("position","absolute");loader.bind("load",function(){Log.output("Loaded image")});var width=sizes[count].width;var height=sizes[count].height;var url=this._mode._image_urls[count];var rec=this._mode._image_recs[count];if(rec){if(url.indexOf("?")!=-1){var url_param=url.split("?");url=url_param[0]+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1&"+url_param[1]}else{url=url+"?sr.zmx="+width+"&sr.zmy="+height+"&sr.fbw=1"}}Log.output("url:"+url);loader.attr({width:viewer.width(),height:viewer.height()});pos=viewer.position();loader.css({left:pos.left,top:pos.top});loader.hide();loader.css("margin","0");loader.css("padding","0");loader.attr("src",url);viewer.before(loader);if(this.loader()){this.loader().hide()}this.loader(loader);this._mode._viewer_pool.push(loader)}},_move:function(from,to){if(!this._mode._image_validity){return}var loader=this.loader();var viewer=this.viewer();var frame=this.frame();this._stop_zoom();if(loader&&loader.css("display")!="none"){loader.hide()}var pos=viewer.position();var x=to.x-from.x;var y=to.y-from.y;pos.left+=x;pos.top+=y;if(pos.left<=0&&pos.top<=0&&Math.abs(pos.left)<=(this._viewer_info.size.width-frame.size().width)&&Math.abs(pos.top)<=(this._viewer_info.size.height-frame.size().height)){viewer.css({left:pos.left,top:pos.top});if(loader){loader.css({left:pos.left,top:pos.top})}}},_stop_zoom:function(){if(this._animation){Log.output("Stop zooming");clearInterval(this._animation);this._animation=null;var viewer=this.viewer();viewer.attr({width:this._viewer_info.size.width,height:this._viewer_info.size.height});viewer.css({left:this._viewer_info.position.x,top:this._viewer_info.position.y});var loader;var pool=this._mode._viewer_pool;if(pool.length){for(var p=0;p<pool.length;p++){if(pool[p]){loader=pool[p];loader.css({left:this._viewer_info.position.x,top:this._viewer_info.position.y});if(loader[0]){loader[0].width=this._viewer_info.position.width;loader[0].height=this._viewer_info.position.height}else{loader.attr({width:this._viewer_info.position.width,height:this._viewer_info.position.height})}viewer.before(loader);loader.css("left")}}}if(this._zoom_cb){this._zoom_cb()}this._zoom_cb=null}},_zoom:function(size,point,cb){if(!this._mode._image_validity){return}if(this._mode._animation){return}Log.output("Zoom image");this._stop_zoom();if(this._mode._zoom_count<this._mode._zoom_limit){this._mode._preload_image()}var self=this;var frame=this.frame();var viewer=this.viewer();var pool=this._mode._viewer_pool;this._zoom_cb=cb;var zoom_count=this._mode._zoom_count;var image_sizes=this._mode._image_std_sizes;var viewer=this.viewer();var viewer_size={width:viewer.width(),height:viewer.height()};var viewer_position=viewer.position();var viewer_offset=viewer.offset();if(parseFloat(((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent))||[0,"4_2"])[1].replace("_","."))<4.1){if(navigator.userAgent.indexOf("4.0.4")!=-1){viewer_offset.left-=window.scrollX;viewer_offset.top-=window.scrollY}}var mouse_offset={x:point.x-viewer_offset.left,y:point.y-viewer_offset.top};var mouse_offset_ratio={x:mouse_offset.x/viewer_size.width,y:mouse_offset.y/viewer_size.height};var target_size={width:size.width,height:size.height};var mouse_target_offset={x:target_size.width*mouse_offset_ratio.x,y:target_size.height*mouse_offset_ratio.y};var target_position={x:mouse_offset.x+viewer_position.left-mouse_target_offset.x,y:mouse_offset.y+viewer_position.top-mouse_target_offset.y};this._viewer_info.position=target_position;this._viewer_info.size=target_size;if(target_position.x>0){target_position.x=0}if(target_position.y>0){target_position.y=0}if(target_position.x+target_size.width<frame.width()){target_position.x=frame.width()-target_size.width}if(target_position.y+target_size.height<frame.height()){target_position.y=frame.height()-target_size.height}var delta_size={width:target_size.width-viewer_size.width,height:target_size.height-viewer_size.height};var delta_position={x:target_position.x-viewer_position.left,y:target_position.y-viewer_position.top};if(pool.length){for(var p=0;p<pool.length;p++){if(pool[p]){pool[p].hide();viewer.before(pool[p])}}}Log.output("Viewer status:size("+viewer_size.width+","+viewer_size.height+"),position("+viewer_position.left+","+viewer_position.top+"),offset("+viewer_offset.left+","+viewer_offset.top+")");Log.output("Mouse status:position("+point.x+","+point.y+"),offset("+mouse_offset.x+","+mouse_offset.x+"),ratio("+mouse_offset_ratio.x+","+mouse_offset_ratio.y+")");Log.output("Target status:size("+target_size.width+","+target_size.height+"),position("+target_position.x+","+target_position.y+")");Log.output("Change delta:size("+delta_size.width+","+delta_size.height+"),position("+delta_position.x+","+delta_position.y+")");this._animation=setInterval(function(){var x;var y;var width;var height;var pool=self._mode._viewer_pool;if(pool.length){for(var p=0;p<pool.length;p++){if(pool[p]){if(pool[p].css("display")!="none"){pool[p].hide()}}}}if(Math.abs(delta_size.width)>1){delta_size.width=delta_size.width/2;viewer_size.width+=delta_size.width;width=viewer_size.width}else{if(Math.abs(delta_size.width)>=0){delta_size.width=0;width=target_size.width}}if(Math.abs(delta_size.height)>1){delta_size.height=delta_size.height/2;viewer_size.height+=delta_size.height;height=viewer_size.height}else{if(Math.abs(delta_size.height)>=0){delta_size.height=0;height=target_size.height}}if(Math.abs(delta_position.x)>1){delta_position.x=delta_position.x/2;viewer_position.left+=delta_position.x;x=viewer_position.left}else{delta_position.x=0;x=target_position.x}if(Math.abs(delta_position.y)>1){delta_position.y=delta_position.y/2;viewer_position.top+=delta_position.y;y=viewer_position.top}else{delta_position.y=0;y=target_position.y}viewer.css({left:x,top:y});viewer[0].width=width;viewer[0].height=height;if((delta_position.x==0&&delta_position.y==0)&&(delta_size.width==0&&delta_size.height==0)){clearInterval(self._animation);self._animation=null;var loader;if(pool.length){for(var p=0;p<pool.length;p++){if(pool[p]){loader=pool[p];loader.css({left:x,top:y});loader.attr({width:width,height:height});viewer.before(loader)}}}if(self.loader()){loader=self.loader();viewer.after(loader);loader.show()}if(cb){cb()}if(self._mode._image_std_sizes[self._mode._zoom_count-1]){self._mode._data[self._mode._index].zoom_count++;self._mode._data[self._mode._index].width=self._mode._image_std_sizes[self._mode._zoom_count-1].width;self._mode._data[self._mode._index].height=self._mode._image_std_sizes[self._mode._zoom_count-1].height;if(self._config.zoom){self._dispatch_event("zoom",self._config,self._mode._data[self._mode._index])}}if(self._mode.mode=="view"&&self._config.open&&!self._open_flag){self._mode._data[self._mode._index].open_count++;self._dispatch_event("open",self._config,self._mode._data[self._mode._index]);self._open_flag=true}}},1);this._mode._init_scale_flag=false},_restore_image:function(){Log.output("Restore image");var self=this;this._stop_zoom();var viewer=this.viewer();var sizes=this._mode._image_std_sizes;var restore_size={width:sizes[0].width,height:sizes[0].height};this._mode._zoom_count=1;this._viewer_info.size={width:this._viewer_info.init_size.width,height:this._viewer_info.init_size.height};this._viewer_info.position={x:this._viewer_info.init_position.x,y:this._viewer_info.init_position.y};viewer.css("position","absolute");viewer.css({left:0,top:0});viewer.attr({width:restore_size.width,height:restore_size.height});if(this._loader){this._loader.css({left:0,top:0});this._loader.attr({width:restore_size.width,height:restore_size.height})}this._loader=null;var loader;if(this._mode._viewer_pool.length){for(var p=0;p<this._mode._viewer_pool.length;p++){if(this._mode._viewer_pool[p]){loader=this._mode._viewer_pool[p];loader.hide();viewer.before(loader)}}}this._mode._data[this._mode._index].restore_count++;this._mode._data[this._mode._index].width=this._mode._image_std_sizes[0].width;this._mode._data[this._mode._index].height=this._mode._image_std_sizes[0].height;if(this._config.restore){this._dispatch_event("restore",this._config,this._mode._data[this._mode._index])}},_remove_cache:function(){if(this._mode._viewer_pool[this._mode._zoom_count]){for(var p=0;p<this._mode._viewer_pool.length;p++){if(this._mode._viewer_pool[p]){loader=this._mode._viewer_pool[p];loader.remove()}}}this._mode._viewer_pool=[]},_bind_events:function(){Log.output("Bind events");var self=this;var frame=this.frame();var viewer=this.viewer();var zoom_start_flag=false;var gesture_start_flag=false;var gesture_flag=false;var move_flag=false;var pinch_zoom_flag=false;var touches;Doc.addEventListener("touchstart",function(e){touches=e.targetTouches});Doc.addEventListener("touchmove",function(e){touches=e.targetTouches;var touch=touches[0];if(touch&&self._touch_image&&self._touch_image.image){var pos={x:touch.pageX,y:touch.pageY};var delta=0;if(navigator.userAgent.indexOf("iPad")!=-1){delta=-50}else{delta=-100}if(parseFloat(((/CPU.+OS ([0-9_]{3}).*AppleWebkit.*Mobile/i.exec(navigator.userAgent))||[0,"4_2"])[1].replace("_","."))<4.1){if(navigator.userAgent.indexOf("4.0.4")!=-1){pos.x+=window.scrollX;pos.y+=window.scrollY}}var image=self._touch_image.image;image.offset({left:pos.x,top:pos.y+delta})}});var _gesture_start=function(e){Log.output("Gesture start");gesture_start_flag=true;gesture_flag=true;pinch_zoom_flag=false;frame.removeEventListener("gesturechange",_gesture_change);frame.removeEventListener("gestureend",_gesture_end);frame.addEventListener("gesturechange",_gesture_change);frame.addEventListener("gestureend",_gesture_end)};var _gesture_change=function(e){var zoom_count=self._mode._zoom_count;if(!pinch_zoom_flag){var frame=self.frame();var viewer=self.viewer();var size;var sizes=self._mode._image_std_sizes;var touch1=touches[0];var touch2=(touches[1])?touches[1]:touches[0];var touch={x:touch1.pageX-(touch1.pageX-touch2.pageX)/2,y:touch1.pageY-(touch1.pageY-touch2.pageY)/2};self._stop_zoom();var zoom_count=self._mode._zoom_count;var zoom_limit=self._mode._zoom_limit;size=sizes[zoom_count];if(e.scale>1.5){size=sizes[zoom_count];if(zoom_count>0&&zoom_count<zoom_limit){self._zoom(size,touch,function(){self._mode._zoom_count++})}pinch_zoom_flag=true;e.preventDefault()}else{if(e.scale<0.8){size=sizes[zoom_count-2];if(zoom_count>1){self._zoom(size,touch,function(){self._mode._zoom_count--})}else{e.preventDefault()}pinch_zoom_flag=true}else{e.preventDefault()}}}else{e.preventDefault()}Doc.removeEventListener("touchmove",_touch_move);Doc.removeEventListener("touchend",_touch_end)};var _gesture_end=function(e){Log.output("Gesture end");e.preventDefault();var gesture_timer=setInterval(function(){gesture_start_flag=false;clearInterval(gesture_timer)},250);if(self._touch_image){self._touch_image.image.remove();self._touch_image=null}frame.removeEventListener("gesturechange",_gesture_change);frame.removeEventListener("gestureend",_gesture_end)};var _touch_start=function(e){if(gesture_start_flag){return}Log.output("Touch start");var zoom_count=self._mode._zoom_count;var zoom_limit=self._mode._zoom_limit;if(zoom_count>1){e.preventDefault()}var frame=self.frame();var viewer=self.viewer();var touch=e.targetTouches[0];if(!touch){touch=touches[0]}if(!gesture_start_flag){pinch_zoom_flag=false;gesture_flag=false}move_flag=false;Doc.removeEventListener("touchmove",_touch_move);Doc.removeEventListener("touchend",_touch_end);Doc.addEventListener("touchmove",_touch_move);Doc.addEventListener("touchend",_touch_end);if(!gesture_flag){Log.output("Touch start");if(zoom_count>0&&zoom_count<zoom_limit){if(self._mode._image_validity&&self._config.zoom_cursor_image&&self._config.zoom_cursor_image.src){if(!self._touch_image||(self._touch_image&&self._touch_image.name!="zoom")){if(touch){self._use_touch_image("zoom",self._config.zoom_cursor_image,touch)}}}else{if(self._touch_image){self._touch_image.image.remove();self._touch_image=null}}}else{if(self._mode._image_validity&&self._config.restore_cursor_image&&self._config.restore_cursor_image.src){if(!self._touch_image||(self._touch_image&&self._touch_image.name!="restore")){if(touch){self._use_touch_image("restore",self._config.restore_cursor_image,touch)}}}else{if(self._touch_image){self._touch_image.image.remove();self._touch_image=null}}}}self._current_pointer={x:touch.pageX,y:touch.pageY}};var _touch_move=function(e){if(!self._animation&&!gesture_flag&&self._mode._zoom_count>0){move_flag=true}if(!self._animation&&!gesture_flag&&self._mode._zoom_count>1){move_flag=true;e.preventDefault();var frame=self.frame();var viewer=self.viewer();var loader=self.loader();var zoom_count=self._mode._zoom_count;var touch=e.targetTouches[0];if(!touch){touch=touches[0]}if(loader){loader.hide()}self._move(self._current_pointer,{x:touch.pageX,y:touch.pageY});if(self._current_pointer.x!=touch.pageX||self._current_pointer.y!=touch.pageY){self._current_pointer={x:touch.pageX,y:touch.pageY}}}if(self._mode._image_validity&&self._config.move_cursor_image&&self._config.move_cursor_image.src){if(!self._touch_image||(self._touch_image&&self._touch_image.name!="move")){if(touch){self._use_touch_image("move",self._config.move_cursor_image,touch)}}}else{if(self._touch_image){self._touch_image.image.remove();self._touch_image=null}}};var _touch_end=function(e){Log.output("Touch end");e.preventDefault();var frame=self.frame();var viewer=self.viewer();var loader=self.loader();var size;var sizes=self._mode._image_std_sizes;Doc.removeEventListener("touchmove",_touch_move);Doc.removeEventListener("touchend",_touch_end);if(self._touch_image){self._touch_image.image.remove();self._touch_image=null}if(loader){loader.show()}if(zoom_start_flag){setTimeout(function(){zoom_start_flag=false},250)}if(!zoom_start_flag&&!gesture_flag&&!move_flag){zoom_start_flag=true;setTimeout(function(){zoom_start_flag=false},250);self._stop_zoom();var zoom_count=self._mode._zoom_count;var zoom_limit=self._mode._zoom_limit;size=sizes[zoom_count];if(zoom_count>0&&zoom_count<zoom_limit){self._zoom(size,self._current_pointer,function(){self._mode._zoom_count++})}else{self._mode._restore_image()}}if(!move_flag){self._mode._data[self._mode._index].click_count++;if(self._config.click){self._dispatch_event("click",self._config,self._mode._data[self._mode._index])}}};frame.addEventListener("gesturestart",_gesture_start);frame.addEventListener("touchstart",_touch_start)}});iphone.ViewMode=Class.create(null,{mode:"view",_owner:null,_config:null,_index:0,_id:null,_body:null,_viewer:null,_viewer_size:null,_viewer_init_size:null,_viewer_position:null,_viewer_init_position:null,_frame:null,_frame_size:null,_org_frame_size:null,_text:null,_page:null,_image_validity:true,_image_urls:null,_image_recs:null,_image_sizes:null,_image_std_sizes:null,_loader:null,_zoom_count:0,_zoom_limit:0,_zoom_cursor:null,_zoom_cursor_image:null,_move_cursor:null,_move_cursor_image:null,_restore_cursor:null,_restore_cursor_image:null,_viewer_pool:null,_position_delta:null,_down_mouse:null,_init_flag:false,_open_flag:false,_moving_flag:false,_animation_flag:false,_down_mouse:null,_mouse:null,_data:null,init:function(owner,config){Log.output("Initialize View mode");this._owner=owner;this._config=config},build:function(){this._index=0;this._id=this._config.id;this.viewer(this._config.viewer);this._viewer.attr("galleryimg","no");this._viewer_pool=[null];this._position_delta={x:0,y:0};this._down_mouse=null;this._data=this._owner._create_data(this._id,this._config.images);this._init_cursor();this._init_frame(this._id,this._viewer);this.show(this._config.init_index);this._init_flag=true},frame:function(e){if(e){this._frame=e}return this._frame},viewer:function(e){if(e){this._viewer=e}return this._viewer},show:function(index){Log.output("Show image (index:"+index+")");var self=this;this._index=index;if(this._init_flag){this._restore_image();this._remove_cache()}this._zoom_count=0;this._update();this._zoom_count=1;this._data[this._index].show_count++;if(this._config.show){this._owner._dispatch_event("show",this._config,this._data[this._index])}},prev:function(){this._owner.prev()},next:function(){this._owner.next()},_init_cursor:function(){var cursor=this._owner._get_cursor(this._config);if(cursor.zoom_cursor){this._zoom_cursor=cursor.zoom_cursor}if(cursor.zoom_cursor_image){this._zoom_cursor_image=cursor.zoom_cursor_image}if(cursor.move_cursor){this._move_cursor=cursor.move_cursor}if(cursor.move_cursor_image){this._move_cursor_image=cursor.move_cursor_image}if(cursor.restore_cursor){this._restore_cursor=cursor.restore_cursor}if(cursor.restore_cursor_image){this._restore_cursor_image=cursor.restore_cursor_image}},_init_frame:function(id,viewer){var size={width:viewer.width(),height:viewer.height()};var display=$("<div class='display'/>");viewer.wrap(display);var display=viewer.parent();var frame=new Frame(display);frame.viewer(viewer);this.frame(frame);this._body=this._owner._init_body(id,this._frame.element());this._page=this._owner._init_page(frame,this._config.page);this._text=this._owner._init_text(frame,this._config.text)},_update:function(){Log.output("update");var url=this._config.images[this._index]["src"];this._image_validity=this._owner._check_validity(url,this._config);var image=this._owner._get_image(this._config.images,this._index);this._image_sizes=image.sizes;this._image_std_sizes=image.std_sizes;this._image_urls=image.urls;this._image_recs=image.recs;this._zoom_limit=image.zoom_limit;var viewer=this._owner._init_viewer(this._viewer,this._image_urls,this._image_recs,this._image_std_sizes,this._zoom_count);this._owner._update_page(this._page,(this._index+1),this._config.images.length);this._owner._update_text(this._text,this._config.images[this._index].text,this._config.text_as_html)},_preload_image:function(){this._owner._preload_image(this)},_move_image:function(x,y){this._owner._move_image(this,x,y)},_restore_image:function(){this._owner._restore_image(this)},_remove_cache:function(){this._owner._remove_cache(this)},_bind_events:function(){this._owner._bind_events(this)}});iphone.WindowMode=Class.create(null,{mode:"window",_owner:null,_config:null,_index:0,_id:null,_viewer:null,_viewer_size:null,_viewer_init_size:null,_viewer_position:null,_viewer_init_position:null,_frame:null,_frame_size:null,_org_frame_size:null,_iframe:null,_text:null,_page:null,_image_validity:true,_image_urls:null,_image_recs:null,_image_sizes:null,_image_std_sizes:null,_loader:null,_zoom_count:0,_zoom_limit:0,_zoom_cursor:null,_zoom_cursor_image:null,_move_cursor:null,_move_cursor_image:null,_restore_cursor:null,_restore_cursor_image:null,_close_button:null,_prev_button:null,_next_button:null,_viewer_pool:null,_position_delta:null,_down_mouse:null,_init_flag:false,_open_flag:false,_moving_flag:false,_animation_flag:false,_down_mouse:null,_mouse:null,_data:null,init:function(owner,config){Log.output("Initialize Window mode");this._owner=owner;this._config=config},build:function(){this._index=0;this._id=this._config.id;this._viewer_pool=[null];this._position_delta={x:0,y:0};this._down_mouse=null;this._data=this._owner._create_data(this._id,this._config.images);this._init_cursor();this._create_env(this._config);this._zoom_count=0;this._update();this._zoom_count=1;this._bind_events();this._init_flag=true},frame:function(e){if(e){this._frame=e}return this._frame},viewer:function(e){if(e){this._viewer=e}return this._viewer},show:function(index){Log.output("Show image (index:"+index+")");var self=this;this._index=index;if(this._init_flag){this._restore_image();this._remove_cache()}this._viewer.css("display","none");this._zoom_count=0;this._update();this._zoom_count=1;if(this._body.css("display")=="none"){this._body.css("display","");this._reposit_display()}this._stretch_bg();if(this._config.open&&!this._open_flag){this._data[this._index].open_count++;this._owner._dispatch_event("open",this._config,this._data[this._index])}this._open_flag=true;this._data[this._index].show_count++;if(this._config.show){this._owner._dispatch_event("show",this._config,this._data[this._index])}this._viewer.css("display","")},prev:function(){this._owner.prev()},next:function(){this._owner.next()},_close:function(){this._restore_image();this._remove_cache();this._body.css("display","none");if(this._config.close){this._owner._dispatch_event("close",this._config,this._data[this._index])}},_create_env:function(opts){var image=opts.images[0];var image_size={width:image.width[0],height:image.height[0]};$("body").height("100%");$("html").height("100%");var bg=$("<div class='background'/>");bg.css("position","absolute");bg.css("left",0);bg.css("top",0);bg.css("background-color","#000000");bg.css("opacity",0.6);bg.css("filter","alpha(opacity=60)");bg.css("width","100%");bg.css("height",$(document).height());$("body").append(bg);var display=$("<div class='display'/>");display.css("position","absolute");display.css("left","50%");display.css("top",$(document).height()/2);display.css("padding",9);if(this._config.prev_button_image&&this._config.prev_button_image.src){display.css("padding-left",this._config.prev_button_image.width)}if(this._config.next_button_image&&this._config.next_button_image.src){display.css("padding-right",this._config.next_button_image.width)}display.css("background-color","white");bg.after(display);var frame=new Frame(display);var viewer=$("<img galleryimg='no'/>");viewer.attr("width",image_size.width);viewer.attr("height",image_size.height);frame.viewer(viewer);var close;if(this._config.close_button_image&&this._config.close_button_image.src){var src=this._config.close_button_image.src;var width=this._config.close_button_image.width;var height=this._config.close_button_image.height;close=jQuery("<div class='close'/>");close.css("background","url("+src+") no-repeat");close.css("width",width);close.css("height",height);close.css("position","absolute");close.css("left","100%");close.css("top",0);close.css("cursor","pointer");close.css("margin-left",-width/2);close.css("margin-top",-height/2);frame.after(close);this._closebtn=close}if(opts.images&&opts.images.length>1){var prev;if(this._config.prev_button_image&&this._config.prev_button_image.src){var src=this._config.prev_button_image.src;var width=this._config.prev_button_image.width;var height=this._config.prev_button_image.height;prev=jQuery("<div class='prev'/>");prev.css("background-image","url("+src+")");prev.css("background-repeat","no-repeat");prev.css("background-position","50% 50%");prev.css("width",width);prev.css("height",height);prev.css("position","absolute");prev.css("padding-left",width);prev.css("padding-right",width);prev.css("padding-top",height);prev.css("padding-bottom",height);prev.css("left",-width);prev.css("top",frame.height()/2-height/2);prev.css("cursor","pointer");prev.css("margin-left",0);prev.css("margin-top",0);frame.after(prev);this._prev=prev}var next;if(this._config.next_button_image&&this._config.next_button_image.src){var src=this._config.next_button_image.src;var width=this._config.next_button_image.width;var height=this._config.next_button_image.height;next=jQuery("<div class='next'/>");next.css("background-image","url("+src+")");next.css("background-repeat","no-repeat");next.css("background-position","50% 50%");next.css("width",width);next.css("height",height);next.css("position","absolute");next.css("padding-left",width);next.css("padding-right",width);next.css("padding-top",height);next.css("padding-bottom",height);next.css("left",display.width()+width);next.css("top",frame.height()/2-height/2);next.css("cursor","pointer");next.css("margin-left",-width);next.css("margin-top",0);frame.after(next);this._next=next}}this._page=this._owner._init_page(frame,this._config.page);this._text=this._owner._init_text(frame,this._config.text);var body=this._owner._init_body(opts.id,bg);body.css("position","absolute");body.css("left",0);body.css("top",0);body.css("width","100%");body.css("height",$(document).height());body.append(display);if(!$.support.opacity&&!$.support.style&&(typeof document.documentElement.style.maxHeight=="undefined")){var iframe=$("<iframe/>");iframe.css("position","absolute");iframe.css("left",0);iframe.css("top",0);iframe.css("border-width",0);iframe.css("filter","alpha(opacity=60)");iframe.css("width",$(document).width());iframe.css("height",$(document).height());body.prepend(iframe);this._iframe=iframe}this._body=body;this._bg=bg;this._display=display;this.frame(frame);this.viewer(viewer);if(close){this._close_button=close}if(prev){this._prev_button=prev}if(next){this._next_button=next}this._body.css("display","none")},_init_cursor:function(){var cursor=this._owner._get_cursor(this._config);if(cursor.zoom_cursor){this._zoom_cursor=cursor.zoom_cursor}if(cursor.zoom_cursor_image){this._zoom_cursor_image=cursor.zoom_cursor_image}if(cursor.move_cursor){this._move_cursor=cursor.move_cursor}if(cursor.move_cursor_image){this._move_cursor_image=cursor.move_cursor_image}if(cursor.restore_cursor){this._restore_cursor=cursor.restore_cursor}if(cursor.restore_cursor_image){this._restore_cursor_image=cursor.restore_cursor_image}},_update:function(){Log.output("update");var url=this._config.images[this._index]["src"];this._image_validity=this._owner._check_validity(url,this._config);var image=this._owner._get_image(this._config.images,this._index);this._image_sizes=image.sizes;this._image_std_sizes=image.std_sizes;this._image_urls=image.urls;this._image_recs=image.recs;this._zoom_limit=image.zoom_limit;var viewer=this._owner._init_viewer(this._viewer,this._image_urls,this._image_recs,this._image_std_sizes,this._zoom_count,"relative");this._owner._update_page(this._page,(this._index+1),this._config.images.length);this._owner._update_text(this._text,this._config.images[this._index].text,this._config.text_as_html)},_preload_image:function(){this._owner._preload_image()},_move_image:function(){this._owner._move_image()},_restore_image:function(){this._owner._restore_image()},_remove_cache:function(){this._viewer.attr("src","");this._owner._remove_cache()},_stretch_bg:function(){this._bg.css("width",$(document).width());this._bg.css("height",$(document).height());if(this._iframe){this._iframe.css("width",$(document).width());this._iframe.css("height",$(document).height())}},_reposit_display:function(){var winWidth=$(window).width();var winHeight=$(window).height();var scrollLeft=$(window).scrollLeft();var scrollTop=$(window).scrollTop();var displayWidth=this._display.outerWidth();var displayHeight=this._display.outerHeight();Log.output("Window width:"+winWidth);Log.output("Window height:"+winHeight);Log.output("Scroll left:"+scrollLeft);Log.output("Scroll top:"+scrollTop);Log.output("Display width:"+displayWidth);Log.output("Display height:"+displayHeight);var left=scrollLeft+winWidth/2-displayWidth/2;var top=scrollTop+winHeight/2-displayHeight/2;if(this._closebtn&&top<(scrollTop+this._closebtn.height()/2+5)){top=scrollTop+this._closebtn.height()/2+5}else{if(top<scrollTop){top=scrollTop}}Log.output("Display left:"+left);Log.output("Display top:"+top);this._display.css("left",left);this._display.css("top",top)},_bind_events:function(){var self=this;$(window).bind("resize",function(e){self._stretch_bg()});window.onorientationchange=function(){self._stretch_bg();self._reposit_display()};this._bg.bind("click",function(e){self._close()});if(this._close_button){this._close_button.bind("click",function(){var src=self._config.close_button_image.src;self._close_button.css("background-image","url("+src+")");self._close()});this._close_button.bind("mouseover",function(){var src=self._config.close_button_image.hover;self._close_button.css("background-image","url("+src+")")});this._close_button.bind("mouseleave",function(){var src=self._config.close_button_image.src;self._close_button.css("background-image","url("+src+")")})}if(this._prev_button){this._prev_button.bind("click",function(){var src=self._config.prev_button_image.src;self._prev_button.css("background-image","url("+src+")");self.prev()});this._prev_button.bind("mouseover",function(){var src=self._config.prev_button_image.hover;self._prev_button.css("background-image","url("+src+")")});this._prev_button.bind("mouseleave",function(){var src=self._config.prev_button_image.src;self._prev_button.css("background-image","url("+src+")")})}if(this._next_button){this._next_button.bind("click",function(){var src=self._config.next_button_image.src;self._next_button.css("background-image","url("+src+")");self.next()});this._next_button.bind("mouseover",function(){var src=self._config.next_button_image.hover;self._next_button.css("background-image","url("+src+")")});this._next_button.bind("mouseleave",function(){var src=self._config.next_button_image.src;self._next_button.css("background-image","url("+src+")")})}}});var viewers={};$.fn.snaprec=function(){var self=this;var args=arguments;if(typeof args[0]=="string"){var _id;var _index;var _viewer;var _param;var _opts={};switch(args[0]){case"default":Config.define(args[1]);break;case"init":if(typeof args[1]=="string"){if(args[1]==""){throw new Error("Invalid Aruguments Error")}_id=args[1];_opts=new Config(_id,null,$("#"+_id).serializeArray())}else{if(typeof args[1]=="object"){_opts=args[1];if(_opts.id){_id=_opts.id}if(_opts.param){if(!_id){_id=_opts.param}_opts=new Config(_id,_opts,$("#"+_opts.param).serializeArray())}else{_opts=new Config(_id,_opts)}}else{throw new Error("Invalid Aruguments Error")}}if(_opts.log){Log.init(_opts.log)}if(checkUA(navigator.userAgent)){_viewer=new iphone.ImageViewer(_id,_opts)}else{_viewer=new ImageViewer(_id,_opts)}viewers[_id]=_viewer;break;case"show":_id=args[1];_index=args[2];_viewer=viewers[_id];if(_viewer){_viewer.show(_index-1)}break;case"prev":_id=args[1];_viewer=viewers[_id];if(_viewer){_viewer.prev()}break;case"next":_id=args[1];_viewer=viewers[_id];if(_viewer){_viewer.next()}break;case"bind":_id=args[1];var conf=new Config();if(typeof args[2]=="string"){_pid=args[2];var params=$("#"+_pid).serializeArray();var _opts={};if(params){for(var p=0;p<params.length;p++){var param=params[p];_opts[param.name]=param.value}}conf.set_handles(null,_opts);_viewer=viewers[_id];if(_viewer){_viewer.bind(conf)}}else{if(typeof args[2]=="object"){opts=args[2];conf.set_handles(opts);_viewer=viewers[_id];if(_viewer){_viewer.bind(conf)}}}break;default:break}}return $(this)};var checkUA=function(ua){if((ua.indexOf("iPhone")||ua.indexOf("iPad"))&&ua.indexOf("Safari")!=-1&&ua.indexOf("Mobile")!=-1){return true}else{return false}}})(jQuery);